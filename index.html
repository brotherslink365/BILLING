<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Billing App â€” Firestore Ready</title>
  <style>
    :root{--accent:#0ea5a4;--muted:#6b7280}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',Arial;background:#f3f4f6;margin:0;color:#0f172a}
    .app{display:flex;min-height:100vh}
    .sidebar{width:220px;background:#0b1220;color:#fff;padding:18px 14px;position:relative}
    .logo{font-weight:700;font-size:18px;margin-bottom:16px}
    .nav a{display:block;color:#cfe9e6;padding:8px;border-radius:6px;text-decoration:none;margin-bottom:6px}
    .nav a.active{background:rgba(255,255,255,0.06)}
    .main{flex:1;padding:20px}
    .card{background:#fff;border-radius:10px;padding:16px;margin-bottom:14px;box-shadow:0 1px 3px rgba(2,6,23,0.06)}
    .row{display:flex;gap:12px}
    .col{flex:1}
    input, select, textarea{width:100%;padding:8px;border:1px solid #e6eef0;border-radius:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .top-stats{display:flex;gap:12px}
    .stat{flex:1;padding:12px;border-radius:8px;background:linear-gradient(180deg,#ffffff,#fbfdfe);box-shadow:0 1px 2px rgba(2,6,23,0.04)}
    .small{padding:6px 8px;font-size:13px}
    .danger{background:#ef4444}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">Billing App</div>
      <nav class="nav">
        <a href="#" data-view="dashboard" class="active">Dashboard</a>
        <a href="#" data-view="customers">Customer Management</a>
        <a href="#" data-view="transactions">Transactions</a>
        <a href="#" data-view="users">Users</a>
        <a href="#" data-view="areas">Areas</a>
        <a href="#" data-view="settings">Settings</a>
      </nav>

      <div style="position:absolute;bottom:18px;left:14px;right:14px;">
        <div class="muted">Last backup: <span id="lastBackupTime">--</span></div>
      </div>
    </aside>

    <main class="main">
      <div id="view-dashboard" class="view card">
        <h2>Dashboard</h2>
        <p class="muted">Quick overview</p>
        <div class="top-stats" style="margin-top:12px">
          <div class="stat">
            <div class="muted">Customers</div>
            <h3 id="countCustomers">0</h3>
          </div>
          <div class="stat">
            <div class="muted">Transactions</div>
            <h3 id="countTransactions">0</h3>
          </div>
        </div>
      </div>

      <div id="view-customers" class="view card" style="display:none">
        <h2>Customer Management</h2>
        <form id="customerForm">
          <input type="hidden" id="customerId" />
          <div class="row">
            <div class="col"><input id="custName" placeholder="Name" required /></div>
            <div class="col"><input id="custPhone" placeholder="Phone number" required /></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="col">
              <select id="custArea">
                <option value="">Select area</option>
              </select>
            </div>
            <div class="col"><input id="custAddress" placeholder="Address (optional)" /></div>
          </div>
          <div style="margin-top:10px"><button class="btn">Save Customer</button></div>
        </form>

        <div style="margin-top:14px" class="card">
          <h4>Customers</h4>
          <table id="customersTable"><thead><tr><th>Name</th><th>Phone</th><th>Area</th><th>Address</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div id="view-transactions" class="view card" style="display:none">
        <h2>Transactions</h2>
        <form id="transactionForm">
          <div class="row">
            <div class="col">
              <select id="txCustomer" required><option value="">Select customer</option></select>
            </div>
            <div class="col"><input id="txAmount" type="number" placeholder="Amount" required /></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="col"><input id="txDate" type="date" /></div>
            <div class="col"><input id="txNote" placeholder="Note (optional)" /></div>
          </div>
          <div style="margin-top:10px"><button class="btn">Save Transaction</button></div>
        </form>

        <div style="margin-top:14px" class="card">
          <h4>Transactions</h4>
          <table id="transactionsTable"><thead><tr><th>Customer</th><th>Amount</th><th>Date</th><th>Note</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div id="view-users" class="view card" style="display:none">
        <h2>Users</h2>
        <form id="userForm">
          <div class="row">
            <div class="col"><input id="userName" placeholder="Username" required /></div>
            <div class="col"><input id="userRole" placeholder="Role (admin/staff)" required /></div>
          </div>
          <div style="margin-top:10px"><button class="btn">Save User</button></div>
        </form>

        <div style="margin-top:14px" class="card">
          <h4>Users</h4>
          <table id="usersTable"><thead><tr><th>Username</th><th>Role</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div id="view-areas" class="view card" style="display:none">
        <h2>Areas</h2>
        <form id="areaForm">
          <div class="row">
            <div class="col"><input id="areaName" placeholder="Area name" required /></div>
            <div class="col"><input id="areaCode" placeholder="Code (optional)" /></div>
          </div>
          <div style="margin-top:10px"><button class="btn">Save Area</button></div>
        </form>

        <div style="margin-top:14px" class="card">
          <h4>Areas</h4>
          <table id="areasTable"><thead><tr><th>Area</th><th>Code</th><th>Action</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div id="view-settings" class="view card" style="display:none">
        <h2>Settings</h2>
        <p class="muted">Firestore sync + LocalStorage fallback enabled</p>
        <div style="margin-top:10px">
          <button id="forceBackup" class="btn">Force Local Backup</button>
          <button id="clearLocal" class="btn" style="background:#ef4444;margin-left:8px">Clear Local Data</button>
        </div>
      </div>

    </main>
  </div>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    /*******************************
     * Firebase config (your project)
     *******************************/
    const firebaseConfig = {
      apiKey: "AIzaSyDgY2_RoHZhxeeFpU_lJWqB3OIaQ1iXDGE",
      authDomain: "billing-system-aeb9c.firebaseapp.com",
      projectId: "billing-system-aeb9c",
      storageBucket: "billing-system-aeb9c.firebasestorage.app",
      messagingSenderId: "1007648091781",
      appId: "1:1007648091781:web:1d329d47ea5b90cd7583ec",
      measurementId: "G-1P7DMCXSLG"
    };

    // Initialize Firebase + Firestore
    firebase.initializeApp(firebaseConfig);
    const fs = firebase.firestore();

    // LocalStorage keys
    const LS = {
      CUSTOMERS: 'bs_customers_v1',
      TRANSACTIONS: 'bs_transactions_v1',
      USERS: 'bs_users_v1',
      AREAS: 'bs_areas_v1',
      LAST: 'bs_last_backup_v1'
    };

    // In-memory arrays
    let customers = [];
    let transactions = [];
    let users = [];
    let areas = [];

    // UI helpers
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // Navigation
    $$('.nav a').forEach(a => a.addEventListener('click', e => {
      e.preventDefault();
      $$('.nav a').forEach(x => x.classList.remove('active'));
      a.classList.add('active');
      showView(a.dataset.view);
    }));

    function showView(name) {
      document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
      const el = document.getElementById('view-' + name);
      if (el) el.style.display = 'block';
      // refresh tables when switching
      if (name === 'customers') renderCustomers();
      if (name === 'transactions') renderTransactions();
      if (name === 'users') renderUsers();
      if (name === 'areas') renderAreas();
    }

    // ---------------- LocalStorage backup/load ----------------
    function saveLocal() {
      try {
        localStorage.setItem(LS.CUSTOMERS, JSON.stringify(customers));
        localStorage.setItem(LS.TRANSACTIONS, JSON.stringify(transactions));
        localStorage.setItem(LS.USERS, JSON.stringify(users));
        localStorage.setItem(LS.AREAS, JSON.stringify(areas));
        const now = new Date().toLocaleString();
        localStorage.setItem(LS.LAST, now);
        $('#lastBackupTime').textContent = now;
        console.log('Saved local backup');
      } catch (err) {
        console.error('saveLocal error', err);
      }
    }

    function loadLocal() {
      try {
        customers = JSON.parse(localStorage.getItem(LS.CUSTOMERS) || '[]');
        transactions = JSON.parse(localStorage.getItem(LS.TRANSACTIONS) || '[]');
        users = JSON.parse(localStorage.getItem(LS.USERS) || '[]');
        areas = JSON.parse(localStorage.getItem(LS.AREAS) || '[]');
        const last = localStorage.getItem(LS.LAST) || '--';
        $('#lastBackupTime').textContent = last;
        console.log('Loaded from localStorage');
      } catch (err) {
        console.error('loadLocal error', err);
      }
    }

    // ---------------- Firestore helpers ----------------
    async function loadFromFirestoreOnce() {
      try {
        const [custSnap, txSnap, usersSnap, areasSnap] = await Promise.all([
          fs.collection('customers').get(),
          fs.collection('transactions').get(),
          fs.collection('users').get(),
          fs.collection('areas').get()
        ]);
        customers = custSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        transactions = txSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        users = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        areas = areasSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        console.log('Loaded collections from Firestore');
        populateAllUIAfterLoad();
        saveLocal();
      } catch (err) {
        console.warn('Firestore load failed, falling back to local', err);
        loadLocal();
        populateAllUIAfterLoad();
      }
    }

    function attachRealtimeListeners() {
      try {
        fs.collection('customers').onSnapshot(snap => {
          customers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          renderCustomers();
          populateCustomerSelect();
          saveLocal();
        }, err => console.warn('customers onSnapshot error', err));

        fs.collection('transactions').onSnapshot(snap => {
          transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          renderTransactions();
          saveLocal();
        }, err => console.warn('transactions onSnapshot error', err));

        fs.collection('users').onSnapshot(snap => {
          users = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          renderUsers();
          saveLocal();
        }, err => console.warn('users onSnapshot error', err));

        fs.collection('areas').onSnapshot(snap => {
          areas = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          renderAreas();
          populateAreaSelect();
          saveLocal();
        }, err => console.warn('areas onSnapshot error', err));
      } catch (err) {
        console.warn('attachRealtimeListeners error', err);
      }
    }

    // CRUD: Customers
    async function addOrUpdateCustomerFirestore(c) {
      if (!c) return;
      try {
        if (c.id) {
          await fs.collection('customers').doc(String(c.id)).set({
            name: c.name, phone: c.phone, area: c.area, address: c.address
          });
        } else {
          const doc = await fs.collection('customers').add({
            name: c.name, phone: c.phone, area: c.area, address: c.address
          });
          c.id = doc.id;
        }
        return c;
      } catch (err) {
        console.error('addOrUpdateCustomerFirestore', err);
        throw err;
      }
    }

    async function deleteCustomerFirestore(id) {
      try {
        await fs.collection('customers').doc(String(id)).delete();
      } catch (err) { console.error('deleteCustomerFirestore', err); throw err; }
    }

    // CRUD: Transactions
    async function addTransactionFirestore(tx) {
      try {
        const doc = await fs.collection('transactions').add(tx);
        return doc.id;
      } catch (err) { console.error('addTransactionFirestore', err); throw err; }
    }
    async function deleteTransactionFirestore(id) {
      try { await fs.collection('transactions').doc(String(id)).delete(); } catch (err) { console.error(err); throw err; }
    }

    // CRUD: Users
    async function addOrUpdateUserFirestore(u) {
      if (!u) return;
      try {
        if (u.id) {
          await fs.collection('users').doc(String(u.id)).set({ username: u.username, role: u.role });
        } else {
          const d = await fs.collection('users').add({ username: u.username, role: u.role });
          u.id = d.id;
        }
        return u;
      } catch (err) { console.error(err); throw err; }
    }
    async function deleteUserFirestore(id) { try { await fs.collection('users').doc(String(id)).delete(); } catch (err) { console.error(err); throw err; } }

    // CRUD: Areas
    async function addOrUpdateAreaFirestore(a) {
      if (!a) return;
      try {
        if (a.id) {
          await fs.collection('areas').doc(String(a.id)).set({ name: a.name, code: a.code });
        } else {
          const d = await fs.collection('areas').add({ name: a.name, code: a.code });
          a.id = d.id;
        }
        return a;
      } catch (err) { console.error(err); throw err; }
    }
    async function deleteAreaFirestore(id) { try { await fs.collection('areas').doc(String(id)).delete(); } catch (err) { console.error(err); throw err; } }

    // ---------------- UI render / populate ----------------
    function populateAllUIAfterLoad() {
      renderCustomers();
      renderTransactions();
      renderUsers();
      renderAreas();
      populateCustomerSelect();
      populateAreaSelect();
      updateStats();
    }

    function renderCustomers() {
      const tbody = $('#customersTable tbody'); tbody.innerHTML = '';
      customers.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(c.name)}</td><td>${escapeHtml(c.phone)}</td><td>${escapeHtml(c.area||'')}</td><td>${escapeHtml(c.address||'')}</td>
          <td>
            <button class="small btn" data-id="${c.id}" data-action="edit-customer">Edit</button>
            <button class="small btn danger" data-id="${c.id}" data-action="del-customer">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
      // attach handlers
      tbody.querySelectorAll('button[data-action="edit-customer"]').forEach(b => b.addEventListener('click', e => {
        const id = e.target.dataset.id; const c = customers.find(x => x.id === id); if (c) {
          $('#customerId').value = c.id; $('#custName').value = c.name || ''; $('#custPhone').value = c.phone || ''; $('#custArea').value = c.area || ''; $('#custAddress').value = c.address || '';
          window.scrollTo(0,0);
        }
      }));
      tbody.querySelectorAll('button[data-action="del-customer"]').forEach(b => b.addEventListener('click', async e => {
        if (!confirm('Delete this customer?')) return;
        const id = e.target.dataset.id;
        try { await deleteCustomerFirestore(id); } catch(err){ alert('Delete failed'); }
      }));
      updateStats();
    }

    function renderTransactions() {
      const tbody = $('#transactionsTable tbody'); tbody.innerHTML = '';
      transactions.slice().reverse().forEach(tx => {
        const cust = customers.find(c => c.id === tx.customerId) || { name: '[Deleted]' };
        const d = tx.date ? (new Date(tx.date)).toLocaleDateString() : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(cust.name)}</td><td>${escapeHtml(tx.amount)}</td><td>${escapeHtml(d)}</td><td>${escapeHtml(tx.note||'')}</td>
          <td><button class="small btn danger" data-id="${tx.id}" data-action="del-tx">Delete</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button[data-action="del-tx"]').forEach(b => b.addEventListener('click', async e => {
        if (!confirm('Delete this transaction?')) return;
        try { await deleteTransactionFirestore(e.target.dataset.id); } catch(err){ alert('Delete failed'); }
      }));
      updateStats();
    }

    function renderUsers() {
      const tbody = $('#usersTable tbody'); tbody.innerHTML = '';
      users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(u.username)}</td><td>${escapeHtml(u.role)}</td><td><button class="small btn danger" data-id="${u.id}" data-action="del-user">Delete</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button[data-action="del-user"]').forEach(b => b.addEventListener('click', async e => {
        if (!confirm('Delete this user?')) return;
        try { await deleteUserFirestore(e.target.dataset.id); } catch(err){ alert('Delete failed'); }
      }));
    }

    function renderAreas() {
      const tbody = $('#areasTable tbody'); tbody.innerHTML = '';
      areas.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(a.name)}</td><td>${escapeHtml(a.code||'')}</td><td><button class="small btn danger" data-id="${a.id}" data-action="del-area">Delete</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button[data-action="del-area"]').forEach(b => b.addEventListener('click', async e => {
        if (!confirm('Delete this area?')) return;
        try { await deleteAreaFirestore(e.target.dataset.id); } catch(err){ alert('Delete failed'); }
      }));
    }

    function populateCustomerSelect() {
      const sel = $('#txCustomer'); sel.innerHTML = '<option value="">Select customer</option>';
      customers.forEach(c => sel.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)} (${escapeHtml(c.phone||'')})</option>`));
    }
    function populateAreaSelect() {
      const sel = $('#custArea'); sel.innerHTML = '<option value="">Select area</option>';
      areas.forEach(a => sel.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(a.name)}">${escapeHtml(a.name)}</option>`));
    }

    function updateStats() {
      $('#countCustomers').textContent = customers.length;
      $('#countTransactions').textContent = transactions.length;
    }

    function escapeHtml(s){ if (s === null || s === undefined) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // ---------------- Form handlers ----------------
    $('#customerForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const id = $('#customerId').value || null;
      const c = { id: id, name: $('#custName').value.trim(), phone: $('#custPhone').value.trim(), area: $('#custArea').value, address: $('#custAddress').value.trim() };
      try {
        await addOrUpdateCustomerFirestore(c);
        // form reset; onSnapshot will update UI; but if offline, update local arrays:
        $('#customerForm').reset(); $('#customerId').value = '';
        if (!navigator.onLine) { // approximate fallback
          loadLocal(); renderCustomers();
        }
      } catch (err) {
        alert('Save failed â€” check console and Firestore rules.');
        console.error(err);
      }
    });

    $('#transactionForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const tx = {
        customerId: $('#txCustomer').value,
        amount: Number($('#txAmount').value) || 0,
        date: $('#txDate').value ? new Date($('#txDate').value).toISOString() : new Date().toISOString(),
        note: $('#txNote').value.trim()
      };
      try {
        await addTransactionFirestore(tx);
        $('#transactionForm').reset();
      } catch (err) {
        alert('Save failed â€” check console and Firestore rules.');
        console.error(err);
      }
    });

    $('#userForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const u = { username: $('#userName').value.trim(), role: $('#userRole').value.trim() };
      try {
        await addOrUpdateUserFirestore(u);
        $('#userForm').reset();
      } catch (err) { alert('Save failed'); console.error(err); }
    });

    $('#areaForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const a = { name: $('#areaName').value.trim(), code: $('#areaCode').value.trim() };
      try {
        await addOrUpdateAreaFirestore(a);
        $('#areaForm').reset();
      } catch (err) { alert('Save failed'); console.error(err); }
    });

    $('#forceBackup').addEventListener('click', () => { saveLocal(); alert('Local backup saved'); });
    $('#clearLocal').addEventListener('click', () => { if (!confirm('Clear local backup?')) return; localStorage.removeItem(LS.CUSTOMERS); localStorage.removeItem(LS.TRANSACTIONS); localStorage.removeItem(LS.USERS); localStorage.removeItem(LS.AREAS); localStorage.removeItem(LS.LAST); alert('Local cleared'); });

    // ---------------- Boot sequence ----------------
    (async function boot() {
      // First try Firestore; if fails, fallback to local.
      try {
        await loadFromFirestoreOnce();
        attachRealtimeListeners();
      } catch (err) {
        console.warn('Firestore boot problem â€” using local fallback', err);
        loadLocal();
        populateAllUIAfterLoad();
      }
      // show dashboard by default
      showView('dashboard');
    })();

    // ---------------- Helpful: expose some functions for console debugging ----------------
    window._bs = {
      saveLocal, loadLocal, loadFromFirestoreOnce, addOrUpdateCustomerFirestore,
      addTransactionFirestore, addOrUpdateUserFirestore, addOrUpdateAreaFirestore,
      customers, transactions, users, areas
    };

  </script>
</body>
</html>
